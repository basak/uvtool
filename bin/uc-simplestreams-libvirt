#!/usr/bin/python

# Keep Ubuntu Cloud images synced to a local libvirt storage pool.

# Copyright (C) 2013 Canonical Ltd.
# Author: Robie Basak <robie.basak@canonical.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# This is written using Python 2 because libvirt bindings were not available
# for Python 3 at the time of writing.

from __future__ import print_function
from __future__ import unicode_literals

import argparse
import subprocess
import sys

import simplestreams.filters
import simplestreams.mirrors
import simplestreams.util

import ubuntucloud.libvirt.simplestreams


def main_sync(args):
    (mirror_url, path) = simplestreams.util.path_from_mirror_url(
        args.mirror_url, args.path)

    smirror = simplestreams.mirrors.UrlMirrorReader(mirror_url)

    filter_list = simplestreams.filters.get_filters(
        [ 'datatype=image-downloads', 'ftype=disk1.img'] + args.filters
    )
    tmirror = ubuntucloud.libvirt.simplestreams.LibvirtMirror(
        filter_list, verbose=args.verbose)
    tmirror.sync(smirror.reader, path)


def main_query(args):
    query = ubuntucloud.libvirt.simplestreams.LibvirtQuery(
        simplestreams.filters.get_filters(args.filters))
    query.sync_products(None, src=_load_products())


def main():
    print(
        "Warning: this CLI is experimental and may change.",
        file=sys.stderr
    )
    system_arch = subprocess.check_output(
        ['dpkg', '--print-architecture']).decode().strip()
    parser = argparse.ArgumentParser()
    parser.add_argument('--verbose', '-v', action='store_true')
    subparsers = parser.add_subparsers()

    sync_subparser = subparsers.add_parser('sync')
    sync_subparser.set_defaults(func=main_sync)
    sync_subparser.add_argument(
        '--path', default=None,
        help='sync from index or products file in mirror'
    )
    sync_subparser.add_argument('--source', dest='mirror_url',
        default='https://cloud-images.ubuntu.com/releases/')
    sync_subparser.add_argument('filters', nargs='*', metavar='filter',
        default=["arch=%s" % system_arch])

    query_subparser = subparsers.add_parser('query')
    query_subparser.set_defaults(func=main_query)
    query_subparser.add_argument(
        'filters', nargs='*', default=[], metavar='filter')

    args = parser.parse_args()
    args.func(args)


if __name__ == '__main__':
    main()
